<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Viewer</title>
<style>
  body{
    font-family:Arial,Helvetica,sans-serif;
    padding:20px;
    font-size:24px;
    background:#f9f9f9;
    max-width:700px;
    margin:auto;
  }
  #domanda{font-weight:bold;margin-bottom:10px;}
  #paragrafo{font-style:italic;margin-bottom:20px;color:#555;}
  .opzione{display:block;padding:10px;margin:10px 0;font-size:20px;cursor:pointer;}
  button.nav-btn{padding:10px 20px;font-size:20px;margin:15px 10px 0 0;}
  #statistiche{margin-top:30px;font-size:20px;color:#333;border-top:1px solid #ccc;padding-top:10px;}
  #timer{font-size:20px;font-weight:bold;margin-bottom:20px;color:#007700;}
  #resetBtn{font-size:18px;padding:5px 15px;margin-top:10px;cursor:pointer;}
</style>
</head>
<body>

<div id="quizContainer">
  <div id="timer">Tempo rimanente: 30:00</div>
  <div id="domanda">Caricamento domanda...</div>
  <div id="paragrafo"></div>
  <div id="opzioni"></div>
  <div>
    <button class="nav-btn" onclick="indietro()">« Indietro</button>
    <button class="nav-btn" onclick="avanti()">Avanti »</button>
  </div>
  <div id="statistiche">
    ✅ Corrette: <span id="corrette">0</span> |
    ❌ Sbagliate: <span id="sbagliate">0</span>
  </div>
  <button id="resetBtn" onclick="resetStatistiche()">Reset Statistiche</button>
</div>

<script>
const quizTxtURL = "https://dl.dropboxusercontent.com/scl/fi/77efym4388elm5acbeeqi/29-39.txt?rlkey=zwu4qaskrew6dj3pq560v7mad&st=7dd6fmdn&dl=1";


let domande = [];
let currentIndex = 0;
let corrette = 0;
let sbagliate = 0;
let timerInterval;
let tempoRimanente = 30 * 60; // 30 minuti

// Carica quiz e avvia timer appena la pagina è pronta
document.addEventListener("DOMContentLoaded", () => {
  loadQuiz();
  startTimer();
});

function loadQuiz() {
  fetch(quizTxtURL)
    .then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    })
    .then(text => {
      domande = parseQuiz(text);
      if (domande.length === 0) {
        document.getElementById("domanda").textContent = "Nessuna domanda trovata.";
        return;
      }
      showQuestion(0);
    })
    .catch(err => {
      document.getElementById("domanda").textContent = "Errore nel caricamento quiz.";
      console.error(err);
    });
}

function parseQuiz(text) {
  const righe = text.split(/\r?\n/).map(r => r.trim()).filter(Boolean);
  const blocchi = [];
  let buf = [];

  righe.forEach(r => {
    if (/^\d+\./.test(r) && buf.length) {
      blocchi.push(buf);
      buf = [r];
    } else {
      buf.push(r);
    }
  });
  if (buf.length) blocchi.push(buf);

  return blocchi.map(b => ({
    domanda: b[0].replace(/^\d+\.\s*/, ""),
    paragrafo: b[1] || "",
    opzioni: { A: b[3] || "", B: b[5] || "", C: b[7] || "", D: b[9] || "" },
    answer: (b.find(x => x.startsWith("Answer:")) || "").split(":")[1]?.trim() || ""
  }));
}

function showQuestion(i) {
  if (i < 0 || i >= domande.length) return;
  currentIndex = i;
  const q = domande[i];
  document.getElementById("domanda").textContent = q.domanda;
  document.getElementById("paragrafo").textContent = q.paragrafo;
  const opDiv = document.getElementById("opzioni");
  opDiv.innerHTML = "";
  Object.entries(q.opzioni).forEach(([lett, testo]) => {
    if (!testo) return;
    const btn = document.createElement("button");
    btn.className = "opzione";
    btn.innerHTML = `<strong>${lett}.</strong> ${testo}`;
    btn.onclick = () => checkAnswer(lett);
    opDiv.appendChild(btn);
  });
}

function checkAnswer(sc) {
  const giusta = domande[currentIndex].answer;
  sc === giusta ? corrette++ : sbagliate++;
  alert(sc === giusta ? "✅ Corretto!" : "❌ Sbagliato! Risposta giusta: " + giusta);
  updateStats();
}

function updateStats() {
  document.getElementById("corrette").textContent = corrette;
  document.getElementById("sbagliate").textContent = sbagliate;
}

function resetStatistiche() {
  corrette = 0; sbagliate = 0; updateStats();
}

function avanti() { if (currentIndex < domande.length - 1) showQuestion(currentIndex + 1); }
function indietro() { if (currentIndex > 0) showQuestion(currentIndex - 1); }

function startTimer() {
  displayTime();
  timerInterval = setInterval(() => {
    if (--tempoRimanente <= 0) {
      clearInterval(timerInterval);
      alert("Tempo scaduto!");
      disabilitaQuiz();
    }
    displayTime();
  }, 1000);
}

function displayTime() {
  const m = String(Math.floor(tempoRimanente / 60)).padStart(2, "0");
  const s = String(tempoRimanente % 60).padStart(2, "0");
  document.getElementById("timer").textContent = `Tempo rimanente: ${m}:${s}`;
}

function disabilitaQuiz() {
  document.querySelectorAll(".opzione, .nav-btn, #resetBtn").forEach(b => b.disabled = true);
}
</script>

</body>
</html>
