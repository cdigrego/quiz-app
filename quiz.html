<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Viewer Protetto</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    font-size: 24px;
    background: #f9f9f9;
    max-width: 700px;
    margin: auto;
  }
  #domanda {
    font-weight: bold;
    margin-bottom: 10px;
  }
  #paragrafo {
    font-style: italic;
    margin-bottom: 20px;
    color: #555;
  }
  .opzione {
    display: block;
    padding: 10px;
    margin: 10px 0;
    font-size: 20px;
    cursor: pointer;
  }
  button {
    padding: 10px 20px;
    font-size: 20px;
    margin: 15px 10px 0 0;
  }
  #statistiche {
    margin-top: 30px;
    font-size: 20px;
    color: #333;
    border-top: 2px solid #4CAF50;
    padding-top: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
  }
  #statistiche span {
    font-weight: bold;
    color: #2e7d32;
  }
  #resetBtn {
    font-size: 18px;
    padding: 5px 12px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    user-select: none;
  }
  #timer {
    font-size: 24px;
    font-weight: bold;
    color: #d32f2f;
    margin-top: 25px;
    text-align: center;
    user-select: none;
  }

  /* Overlay password */
  #loginOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #loginBox {
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    text-align: center;
    max-width: 320px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  #loginBox h2 {
    margin-bottom: 20px;
  }
  #loginBox input[type="password"] {
    font-size: 22px;
    padding: 10px;
    width: 100%;
    margin-bottom: 20px;
    border: 2px solid #4CAF50;
    border-radius: 6px;
    outline: none;
  }
  #loginBox button {
    font-size: 22px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #loginError {
    color: #d32f2f;
    margin-top: 10px;
    min-height: 24px;
  }
</style>
</head>
<body>

<!-- Overlay password -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Inserisci password per iniziare</h2>
    <input type="password" id="passwordInput" placeholder="Password..." autofocus />
    <button onclick="checkPassword()">Accedi</button>
    <div id="loginError"></div>
  </div>
</div>

<div id="quizContainer" style="display:none;">
  <div id="domanda">Caricamento domanda...</div>
  <div id="paragrafo"></div>
  <div id="opzioni"></div>
  <div>
    <button onclick="indietro()">« Indietro</button>
    <button onclick="avanti()">Avanti »</button>
  </div>

  <div id="statistiche">
    <div>
      ✅ Corrette: <span id="corrette">0</span> |
      ❌ Sbagliate: <span id="sbagliate">0</span>
    </div>
    <button id="resetBtn" onclick="resetStatistiche()">Reset Statistiche</button>
  </div>

  <div id="timer">Tempo rimanente: 30:00</div>
</div>

<script>
const QUIZ_PASSWORD = "mypass123"; // <--- Metti qui la tua password!

const quizTxtURL = "https://cdigrego.github.io/quiz-app/quiz.txt";

let domande = [];
let currentIndex = 0;
let corrette = 0;
let sbagliate = 0;

let timerDurata = 30 * 60; // 30 minuti in secondi
let timerIntervallo;

function checkPassword() {
  const pw = document.getElementById("passwordInput").value;
  const errorDiv = document.getElementById("loginError");
  if (pw === QUIZ_PASSWORD) {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("quizContainer").style.display = "block";
    caricaQuiz();
  } else {
    errorDiv.textContent = "Password errata, riprova.";
  }
}

function caricaQuiz() {
  fetch(quizTxtURL)
    .then(response => response.text())
    .then(text => {
      domande = parseQuiz(text);
      showQuestion(currentIndex);
      startTimer();
    })
    .catch(err => {
      document.getElementById('domanda').textContent = "Errore nel caricamento quiz.";
      console.error(err);
    });
}

function parseQuiz(text) {
  let righe = text.split(/\r?\n/).map(r => r.trim()).filter(r => r.length > 0);
  let blocchi = [];
  let buffer = [];

  for (let r of righe) {
    if (/^\d+\./.test(r) && buffer.length > 0) {
      blocchi.push(buffer);
      buffer = [r];
    } else {
      buffer.push(r);
    }
  }
  if (buffer.length > 0) blocchi.push(buffer);

  return blocchi.map(b => {
    return {
      domanda: b[0].replace(/^\d+\.\s*/, ""),
      paragrafo: b[1] || "",
      opzioni: {
        A: b[3] || "",
        B: b[5] || "",
        C: b[7] || "",
        D: b[9] || ""
      },
      answer: (b.find(r => r.startsWith("Answer:")) || "").split(":")[1]?.trim() || ""
    };
  });
}

function showQuestion(i) {
  if (i < 0 || i >= domande.length) return;
  const q = domande[i];
  currentIndex = i;
  document.getElementById("domanda").textContent = q.domanda;
  document.getElementById("paragrafo").textContent = q.paragrafo;
  const opDiv = document.getElementById("opzioni");
  opDiv.innerHTML = "";

  Object.entries(q.opzioni).forEach(([lett, text]) => {
    const btn = document.createElement("button");
    btn.className = 'opzione';
    btn.innerHTML = `<strong>${lett}.</strong> ${text}`;
    btn.onclick = () => checkAnswer(lett);
    btn.disabled = false;
    opDiv.appendChild(btn);
  });
}

function checkAnswer(scelta) {
  const q = domande[currentIndex];

  // Disabilita i bottoni dopo la risposta
  const buttons = document.querySelectorAll('.opzione');
  buttons.forEach(btn => btn.disabled = true);

  if (scelta === q.answer) {
    alert("✅ Corretto!");
    corrette++;
  } else {
    alert("❌ Sbagliato! La risposta giusta è: " + q.answer);
    sbagliate++;
  }

  aggiornaStatistiche();
}

function aggiornaStatistiche() {
  document.getElementById("corrette").textContent = corrette;
  document.getElementById("sbagliate").textContent = sbagliate;
}

function resetStatistiche() {
  corrette = 0;
  sbagliate = 0;
  aggiornaStatistiche();
}

function avanti() {
  if (currentIndex < domande.length - 1) {
    currentIndex++;
    showQuestion(currentIndex);
  }
}

function indietro() {
  if (currentIndex > 0) {
    currentIndex--;
    showQuestion(currentIndex);
  }
}

function startTimer() {
  updateTimerDisplay(timerDurata);
  timerIntervallo = setInterval(() => {
    timerDurata--;
    updateTimerDisplay(timerDurata);

    if (timerDurata <= 0) {
      clearInterval(timerIntervallo);
      timerDurata = 0;
      updateTimerDisplay(timerDurata);
      disabilitaQuiz();
      alert("⏰ Tempo scaduto! Il quiz è terminato.");
    }
  }, 1000);
}

function updateTimerDisplay(secondiRimanenti) {
  const min = Math.floor(secondiRimanenti / 60);
  const sec = secondiRimanenti % 60;
  document.getElementById("timer").textContent = `Tempo rimanente: ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

function disabilitaQuiz() {
  const buttons = document.querySelectorAll('.opzione');
  buttons.forEach(btn => btn.disabled = true);
  // Disabilito anche avanti/indietro per sicurezza
  document.querySelectorAll('#quizContainer > div > button').forEach(btn => btn.disabled = true);
}
</script>

</body>
</html>
